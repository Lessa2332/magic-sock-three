<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Magic Christmas Sock ‚Äî AR –ü—Ä–∏–º—ñ—Ä–∫–∞</title>
<style>
  :root{
    --bg:#fbf7f2;
    --panel:#fffaf4;
    --accent:#e7d6c4;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  #app{
    position:relative;
    width:100%;
    height:100vh;
    overflow:hidden;
  }
  video#camera {
    position: absolute;
    top:0; left:0;
    width:100%; height:100%;
    object-fit:cover;
    transform: scaleX(-1);
    display:none;
    z-index: 0;
  }
  canvas#overlay-canvas{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    display:block;
    transform: scaleX(-1);
    z-index: 1;
    pointer-events: none;
  }
  canvas#snow-canvas{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
    z-index:2;
    mix-blend-mode:screen;
  }
  .ui{
    position: absolute;
    z-index: 10;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    display:flex;
    gap:12px;
    align-items:center;
  }
  .btn{
    background:var(--panel);
    border:1px solid var(--accent);
    padding:10px 14px;
    border-radius:12px;
    font-size:15px;
    cursor:pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  }
  .btn:active{transform:translateY(1px);}
  .top-left{
    position:absolute;
    top:14px; left:14px; z-index:10;
    background:rgba(255,255,255,0.8);
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--accent);
    font-size:14px;
  }
  .hint{
    position:absolute;
    top:14px; right:14px; z-index:10;
    background:rgba(255,250,245,0.9);
    padding:6px 10px;border-radius:10px;border:1px solid var(--accent);
    font-size:13px;
  }
  @media (max-width:600px){
    .btn{font-size:14px;padding:10px;}
    .top-left,.hint{font-size:12px}
  }
</style>
</head>
<body>
<div id="app">
  <video id="camera" playsinline muted></video>
  <canvas id="overlay-canvas"></canvas>
  <canvas id="snow-canvas"></canvas>
  <div class="top-left">Magic Sock AR ‚Äî –ü—Ä–∏–º—ñ—Ä–∫–∞ –Ω–∞ –Ω–æ–≥—É üë£</div>
  <div class="hint">–î–æ–∑–≤–æ–ª—å –∫–∞–º–µ—Ä—É ‚Üí –ø–æ–∫–∞–∂–∏ —Å—Ç–æ–ø—É ‚Üí –Ω–∞—Ç–∏—Å–Ω–∏ üì∏ –¥–ª—è —Ñ–æ—Ç–æ</div>
  <div class="ui">
    <button id="changeBtn" class="btn">üß¶ –ó–º—ñ–Ω–∏—Ç–∏ –¥–∏–∑–∞–π–Ω</button>
    <button id="saveBtn" class="btn">üì∏ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ç–æ</button>
    <button id="flipBtn" class="btn">üîÅ –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏</button>
  </div>
</div>

<script type="module">
  // === –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ª–∏—à–µ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å–Ω–∏–π —ñ–º–ø–æ—Ä—Ç (–±–µ–∑ loadScript) ===
  import { PoseLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

  // === –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ===
  const SOCK_PNGS = ['sock1.png', 'sock2.png', 'sock3.png'];
  let currentSockIndex = 0;
  let currentSockImage = null;
  let poseLandmarker = null;
  let flipped = true;

  // === DOM ===
  const video = document.getElementById('camera');
  const overlayCanvas = document.getElementById('overlay-canvas');
  const snowCanvas = document.getElementById('snow-canvas');
  const overlayCtx = overlayCanvas.getContext('2d');
  const snowCtx = snowCanvas.getContext('2d');

  // === –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —à–∫–∞—Ä–ø–µ—Ç–∫–∏ ===
  function loadSockImage(index) {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      currentSockImage = img;
      redraw();
    };
    img.src = SOCK_PNGS[index];
  }

  // === –ú–∞–ª—é–≤–∞–Ω–Ω—è —à–∫–∞—Ä–ø–µ—Ç–∫–∏ ===
  function drawSock(x, y, angle, scale) {
    if (!currentSockImage) return;
    overlayCtx.save();
    overlayCtx.translate(x, y);
    overlayCtx.rotate(angle);
    const w = overlayCanvas.width * scale;
    const h = (currentSockImage.height / currentSockImage.width) * w;
    overlayCtx.drawImage(currentSockImage, -w / 2, -h / 2, w, h);
    overlayCtx.restore();
  }

  function redraw() {
    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
  }

  // === –û–±—Ä–æ–±–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ MediaPipe ===
  function onResults(results) {
    redraw();
    if (results.poseLandmarks?.length > 0) {
      const L = results.poseLandmarks[0];
      const leftAnkle = L[27];
      const rightAnkle = L[28];
      const leftToe = L[31];
      const rightToe = L[32];

      let ankle, toePt;
      if (rightAnkle && leftAnkle) {
        ankle = rightAnkle.y > leftAnkle.y ? rightAnkle : leftAnkle;
        toePt = rightAnkle.y > leftAnkle.y ? rightToe : leftToe;
      } else {
        ankle = rightAnkle || leftAnkle;
        toePt = rightToe || leftToe;
      }

      if (ankle && toePt && ankle.visibility > 0.4 && toePt.visibility > 0.4) {
        const ax = ankle.x * overlayCanvas.width;
        const ay = ankle.y * overlayCanvas.height;
        const tx = toePt.x * overlayCanvas.width;
        const ty = toePt.y * overlayCanvas.height;

        const angle = Math.atan2(ty - ay, tx - ax);
        const dist = Math.hypot(tx - ax, ty - ay);
        const scale = Math.min(0.8, Math.max(0.2, dist / overlayCanvas.width * 3));

        drawSock(ax, ay, angle, scale);
      }
    }
  }

  // === –ö–∞–º–µ—Ä–∞ ===
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });
      video.srcObject = stream;
      video.style.display = 'block';
      await video.play();
      resize();
    } catch (e) {
      console.error('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
      alert('–î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –¥–æ–¥–∞—Ç–∫—É.');
    }
  }

  // === MediaPipe ===
  async function initPose() {
    const filesetResolver = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
    );
    poseLandmarker = await PoseLandmarker.createFromOptions(filesetResolver, {
      baseOptions: {
        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_heavy/float16/1/pose_landmarker_heavy.float16.tflite"
      },
      runningMode: "VIDEO",
      numPoses: 1
    });
  }

  // === –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–Ω—ñ–≥—É ===
  let snowParticles = [];
  function initSnow() {
    const count = Math.round((overlayCanvas.width / 100) * 6);
    snowParticles = [];
    for (let i = 0; i < count; i++) {
      snowParticles.push({
        x: Math.random() * snowCanvas.width,
        y: Math.random() * snowCanvas.height,
        r: 1 + Math.random() * 3,
        dx: (Math.random() - 0.5) * 0.5,
        dy: 0.4 + Math.random() * 1.2,
        phase: Math.random() * Math.PI * 2
      });
    }
  }
  function animateSnow() {
    snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
    snowCtx.fillStyle = 'rgba(255,255,255,0.95)';
    for (const p of snowParticles) {
      snowCtx.beginPath();
      snowCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      snowCtx.fill();
      p.phase += 0.02;
      p.x += p.dx + Math.sin(p.phase) * 0.3;
      p.y += p.dy;
      if (p.y > snowCanvas.height) p.y = -10;
      if (p.x < -10) p.x = snowCanvas.width;
      if (p.x > snowCanvas.width) p.x = -10;
    }
    requestAnimationFrame(animateSnow);
  }

  // === –ó–∞—Ö–æ–ø–ª–µ–Ω–Ω—è —Ñ–æ—Ç–æ ===
  document.getElementById('saveBtn').addEventListener('click', () => {
    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = overlayCanvas.width;
    finalCanvas.height = overlayCanvas.height;
    const fctx = finalCanvas.getContext('2d');

    fctx.drawImage(video, 0, 0, finalCanvas.width, finalCanvas.height);
    if (flipped) {
      fctx.translate(finalCanvas.width, 0);
      fctx.scale(-1, 1);
    }
    fctx.drawImage(overlayCanvas, 0, 0);

    const link = document.createElement('a');
    link.download = 'magic_sock.png';
    link.href = finalCanvas.toDataURL('image/png');
    link.click();
  });

  // === –ö–Ω–æ–ø–∫–∏ ===
  document.getElementById('changeBtn').addEventListener('click', () => {
    currentSockIndex = (currentSockIndex + 1) % SOCK_PNGS.length;
    loadSockImage(currentSockIndex);
  });

  document.getElementById('flipBtn').addEventListener('click', () => {
    flipped = !flipped;
    video.style.transform = flipped ? 'scaleX(-1)' : 'scaleX(1)';
    overlayCanvas.style.transform = flipped ? 'scaleX(-1)' : 'scaleX(1)';
  });

  // === –†–µ—Å–∞–π–∑ ===
  function resize() {
    [overlayCanvas, snowCanvas].forEach(c => {
      c.width = window.innerWidth;
      c.height = window.innerHeight;
      c.style.width = `${window.innerWidth}px`;
      c.style.height = `${window.innerHeight}px`;
    });
    initSnow();
  }
  window.addEventListener('resize', resize);

  // === –ì–æ–ª–æ–≤–Ω–∏–π —Ü–∏–∫–ª ===
  let lastVideoTime = -1;
  function detectLoop() {
    if (poseLandmarker && video.currentTime !== lastVideoTime) {
      lastVideoTime = video.currentTime;
      poseLandmarker.detectForVideo(video, performance.now()).then(onResults);
    }
    requestAnimationFrame(detectLoop);
  }

  // === –°—Ç–∞—Ä—Ç ===
  async function main() {
    try {
      resize();
      loadSockImage(0);
      await Promise.all([startCamera(), initPose()]);
      detectLoop();
      animateSnow();
    } catch (e) {
      console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:', e);
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + e.message);
    }
  }
  main();
</script>
</body>
</html>

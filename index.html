<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Magic Christmas Sock ‚Äî AR –ü—Ä–∏–º—ñ—Ä–∫–∞</title>
  <style>
    :root{
      --bg:#fbf7f2;
      --panel:#fffaf4;
      --accent:#e7d6c4;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    #app{
      position:relative;
      width:100%;
      height:100vh;
      overflow:hidden;
    }
    video#camera {
      position: absolute;
      top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      transform: scaleX(-1);
      display:none;
      z-index: 0;
    }
    canvas#three-canvas{
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      display:block;
      transform: scaleX(-1);
      z-index: 1;
    }
    canvas#snow-canvas{
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
      z-index:2;
      mix-blend-mode:screen;
    }
    .ui{
      position: absolute;
      z-index: 10;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      gap:12px;
      align-items:center;
    }
    .btn{
      background:var(--panel);
      border:1px solid var(--accent);
      padding:10px 14px;
      border-radius:12px;
      font-size:15px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .btn:active{transform:translateY(1px);}
    .top-left{
      position:absolute;
      top:14px; left:14px; z-index:10;
      background:rgba(255,255,255,0.8);
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--accent);
      font-size:14px;
    }
    .hint{
      position:absolute;
      top:14px; right:14px; z-index:10;
      background:rgba(255,250,245,0.9);
      padding:6px 10px;border-radius:10px;border:1px solid var(--accent);
      font-size:13px;
    }
    @media (max-width:600px){
      .btn{font-size:14px;padding:10px;}
      .top-left,.hint{font-size:12px}
    }
  </style>
</head>
<body>
<div id="app">
  <video id="camera" playsinline muted></video>
  <canvas id="three-canvas"></canvas>
  <canvas id="snow-canvas"></canvas>
  <div class="top-left">Magic Sock AR ‚Äî –ü—Ä–∏–º—ñ—Ä–∫–∞ –Ω–∞ –Ω–æ–≥—É üë£</div>
  <div class="hint">–î–æ–∑–≤–æ–ª—å –∫–∞–º–µ—Ä—É ‚Üí –ø–æ–∫–∞–∂–∏ —Å—Ç–æ–ø—É ‚Üí –Ω–∞—Ç–∏—Å–Ω–∏ üì∏ –¥–ª—è —Ñ–æ—Ç–æ</div>
  <div class="ui">
    <button id="changeBtn" class="btn">üß¶ –ó–º—ñ–Ω–∏—Ç–∏ –¥–∏–∑–∞–π–Ω</button>
    <button id="saveBtn" class="btn">üì∏ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ç–æ</button>
    <button id="flipBtn" class="btn">üîÅ –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏</button>
  </div>
</div>

<script type="module">
  // === –í–ò–ü–†–ê–í–õ–ï–ù–û: URL –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤ ===
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js';
  import { PoseLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

  // === –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ===
  const SOCK_TEXTURES = ['sock1.png', 'sock2.png', 'sock3.png'];
  let currentSockIndex = 0;
  let poseLandmarker = null;
  let flipped = true;

  // === DOM ===
  const video = document.getElementById('camera');
  const threeCanvas = document.getElementById('three-canvas');
  const snowCanvas = document.getElementById('snow-canvas');
  const snowCtx = snowCanvas.getContext('2d');

  // === Three.js —Å—Ü–µ–Ω–∞ ===
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 10);
  camera.position.z = 1;

  const renderer = new THREE.WebGLRenderer({
    canvas: threeCanvas,
    alpha: true,
    antialias: true
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio || 1);
  renderer.setClearColor(0x000000, 0);

  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9);
  scene.add(hemiLight);

  // === –ú–æ–¥–µ–ª—å —à–∫–∞—Ä–ø–µ—Ç–∫–∏ ===
  const sockMaterial = new THREE.MeshBasicMaterial({
    transparent: true,
    side: THREE.DoubleSide,
    depthTest: true
  });

  const leg = new THREE.Mesh(
    new THREE.CylinderGeometry(0.095, 0.11, 0.32, 16),
    sockMaterial
  );
  leg.position.y = 0.18;

  const toe = new THREE.Mesh(
    new THREE.SphereGeometry(0.1, 12, 12, 0, Math.PI * 2, 0, Math.PI / 2),
    sockMaterial
  );
  toe.position.y = -0.02;
  toe.rotation.x = Math.PI;

  const sockGroup = new THREE.Group();
  sockGroup.add(leg, toe);
  sockGroup.scale.x = -1;
  sockGroup.visible = false;
  scene.add(sockGroup);

  const textureLoader = new THREE.TextureLoader();
  function loadSockTexture(index) {
    textureLoader.load(
      SOCK_TEXTURES[index],
      (texture) => {
        texture.colorSpace = THREE.SRGBColorSpace;
        sockMaterial.map = texture;
        sockMaterial.needsUpdate = true;
      },
      undefined,
      (err) => {
        console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–µ–∫—Å—Ç—É—Ä—É:', err);
        sockMaterial.map = null;
        sockMaterial.color.setHex(0xff6b6b);
        sockMaterial.needsUpdate = true;
      }
    );
  }

  // === –°–Ω—ñ–≥ ===
  let snowParticles = [];
  function initSnow() {
    const count = Math.round((snowCanvas.width / 100) * 6);
    snowParticles = [];
    for (let i = 0; i < count; i++) {
      snowParticles.push({
        x: Math.random() * snowCanvas.width,
        y: Math.random() * snowCanvas.height,
        r: 1 + Math.random() * 3,
        dx: (Math.random() - 0.5) * 0.5,
        dy: 0.4 + Math.random() * 1.2,
        phase: Math.random() * Math.PI * 2
      });
    }
  }
  function animateSnow() {
    snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
    snowCtx.fillStyle = 'rgba(255,255,255,0.95)';
    for (const p of snowParticles) {
      snowCtx.beginPath();
      snowCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      snowCtx.fill();
      p.phase += 0.02;
      p.x += p.dx + Math.sin(p.phase) * 0.3;
      p.y += p.dy;
      if (p.y > snowCanvas.height) p.y = -10;
      if (p.x < -10) p.x = snowCanvas.width;
      if (p.x > snowCanvas.width) p.x = -10;
    }
    requestAnimationFrame(animateSnow);
  }

  // === –ü–æ–∑–∞ ‚Üí –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —à–∫–∞—Ä–ø–µ—Ç–∫–∏ ===
  function updateSockFromPose(landmarks) {
    if (!landmarks) {
      sockGroup.visible = false;
      return;
    }

    const L = landmarks;
    const leftAnkle = L[27];
    const rightAnkle = L[28];
    const leftToe = L[31];
    const rightToe = L[32];

    let ankle, toePt;
    if (rightAnkle && leftAnkle) {
      ankle = rightAnkle.y > leftAnkle.y ? rightAnkle : leftAnkle;
      toePt = rightAnkle.y > leftAnkle.y ? rightToe : leftToe;
    } else {
      ankle = rightAnkle || leftAnkle;
      toePt = rightToe || leftToe;
    }

    if (ankle && toePt && ankle.visibility > 0.4 && toePt.visibility > 0.4) {
      const ax = (ankle.x - 0.5) * 2;
      const ay = -(ankle.y - 0.5) * 2;
      const tx = (toePt.x - 0.5) * 2;
      const ty = -(toePt.y - 0.5) * 2;

      sockGroup.position.x = ax * (window.innerWidth / window.innerHeight) * 0.9;
      sockGroup.position.y = ay * 0.95;

      const angle = Math.atan2(ty - ay, tx - ax);
      sockGroup.rotation.z = -angle;

      const dist = Math.hypot(tx - ax, ty - ay);
      const scale = THREE.MathUtils.clamp(0.6 + dist * 1.2, 0.6, 1.6);
      sockGroup.scale.set(scale, scale, 1);

      sockGroup.visible = true;
    } else {
      sockGroup.visible = false;
    }
  }

  // === –ö–∞–º–µ—Ä–∞ ===
  async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    video.srcObject = stream;
    video.style.display = 'block';
    await video.play();
    resize();
  }

  // === MediaPipe ===
  async function initPose() {
    // === –í–ò–ü–†–ê–í–õ–ï–ù–û: URL –±–µ–∑ –ø—Ä–æ–±—ñ–ª—ñ–≤ ===
    const filesetResolver = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
    );
    poseLandmarker = await PoseLandmarker.createFromOptions(filesetResolver, {
      baseOptions: {
        // === –í–ò–ü–†–ê–í–õ–ï–ù–û: –Ω–æ–≤–∏–π URL –º–æ–¥–µ–ª—ñ ===
        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker/float16/1/pose_landmarker.tflite"
      },
      runningMode: "VIDEO",
      numPoses: 1
    });
  }

  // === –ï–∫—Å–ø–æ—Ä—Ç —Ñ–æ—Ç–æ ===
  document.getElementById('saveBtn').addEventListener('click', () => {
    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = threeCanvas.width;
    finalCanvas.height = threeCanvas.height;
    const ctx = finalCanvas.getContext('2d');

    ctx.drawImage(video, 0, 0, finalCanvas.width, finalCanvas.height);
    if (flipped) {
      ctx.translate(finalCanvas.width, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(threeCanvas, 0, 0);

    const link = document.createElement('a');
    link.download = 'magic_sock.png';
    link.href = finalCanvas.toDataURL('image/png');
    link.click();
  });

  // === –ö–Ω–æ–ø–∫–∏ ===
  document.getElementById('changeBtn').addEventListener('click', () => {
    currentSockIndex = (currentSockIndex + 1) % SOCK_TEXTURES.length;
    loadSockTexture(currentSockIndex);
  });

  document.getElementById('flipBtn').addEventListener('click', () => {
    flipped = !flipped;
    video.style.transform = flipped ? 'scaleX(-1)' : 'scaleX(1)';
    threeCanvas.style.transform = flipped ? 'scaleX(-1)' : 'scaleX(1)';
  });

  // === –†–µ—Å–∞–π–∑ ===
  function resize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    [threeCanvas, snowCanvas].forEach(c => {
      c.width = w;
      c.height = h;
      c.style.width = `${w}px`;
      c.style.height = `${h}px`;
    });
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
    initSnow();
  }
  window.addEventListener('resize', resize);

  // === –ì–æ–ª–æ–≤–Ω–∏–π —Ü–∏–∫–ª ===
  let lastVideoTime = -1;
  function detectLoop() {
    if (poseLandmarker && video.currentTime !== lastVideoTime) {
      lastVideoTime = video.currentTime;
      poseLandmarker.detectForVideo(video, performance.now()).then(results => {
        if (results.landmarks?.length > 0) {
          updateSockFromPose(results.landmarks[0]);
        }
        renderer.render(scene, camera);
      });
    } else {
      renderer.render(scene, camera);
    }
    requestAnimationFrame(detectLoop);
  }

  // === –°—Ç–∞—Ä—Ç ===
  async function main() {
    try {
      loadSockTexture(0);
      await Promise.all([startCamera(), initPose()]);
      detectLoop();
      animateSnow();
    } catch (e) {
      console.error('–ü–æ–º–∏–ª–∫–∞:', e);
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É: ' + e.message);
    }
  }
  main();
</script>
</body>
</html>

